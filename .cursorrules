# Cursor AI — Project Rules

Follow these rules for all code generation and edits in this repo.

---

## Database Queries

- **ALWAYS** use explicit field selection (never `SELECT *` or `.select('*')`).
- **ALWAYS** scope by `project_id` when querying tasks.
- **ALWAYS** scope by `owner_id` or `user_id` when querying user-owned data.
- **ALWAYS** use RPC functions for multi-step operations that must be atomic.

---

## Server Actions

- **ALWAYS** use the `'use server'` directive in server action files.
- **ALWAYS** call `revalidatePath` (or `revalidateTag`) after mutations — never rely on manual refetch (e.g. no `load*()` after an action in the same handler).
- **NEVER** use `createClient()` from `@/lib/supabase/client` in components. Use server actions or server components with `@/lib/supabase/server` only.

---

## Data Loading (CRITICAL)

- **ALWAYS** fetch initial page data in Server Components (page.tsx)
- **NEVER** use useEffect to fetch data on component mount
- **ALWAYS** wrap read-only server actions with React cache()
- **ALWAYS** pass data to client components as props

### Pattern

```typescript
// page.tsx (Server Component)
export default async function Page() {
  const data = await getDataAction() // ← Server-side
  return <PageClient initialData={data} />
}

// actions.ts
import { cache } from 'react'
export const getDataAction = cache(async () => { ... })

// PageClient.tsx
'use client'
export default function PageClient({ initialData }) {
  const [data, setData] = useState(initialData) // ← From props
  // NO useEffect to fetch initial data
}
```

### Forbidden

```typescript
// ❌ NEVER DO THIS
'use client'
export default function Page() {
  useEffect(() => {
    fetchData() // ❌ FORBIDDEN for initial page data
  }, [])
}
```

### Before Generating ANY Page Component

1. Check: Is this initial page data? → Fetch server-side
2. Check: Is action read-only? → Wrap with cache()
3. Check: Does client need data? → Pass as props
4. NEVER create useEffect for initial data fetch

Refer to: docs/patterns/data-loading.md

---

## Code Style and Formatting

- **ALWAYS** match the project’s Prettier config (`.prettierrc`): semicolons, single quotes, `tabWidth: 2`, `trailingComma: "es5"`.
- **After generating or editing code**, run `npx prettier --write <edited-files>` (or `npx prettier --write .` for many files) so the pre-commit `format:check` passes and the user can commit without re-running Prettier.

---

## Before Generating Code

1. **Check** `docs/patterns/` for the relevant pattern (server-actions.md, database-queries.md, transactions.md).
2. **Use** `templates/` for boilerplate (server-action.template.ts, rpc-function.template.sql, optimistic-update.template.ts).
3. **Follow** CURSOR_RULES.md strictly when it exists in the repo.

**Reference `docs/patterns/` before every code generation.**
